<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>City Train Network</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: sans-serif; display: flex; margin: 0; }
  #sidebar { width: 200px; padding: 10px; border-right: 1px solid #ccc; }
  #graph { flex: 1; }
  .node circle { stroke: #333; stroke-width: 1.5px; }
  .node text { pointer-events: none; font-size: 12px; }
  .link { fill: none; stroke: #999; stroke-opacity: 0.6; stroke-width: 1.5px; marker-end: url(#arrowhead); }
  .hidden { opacity: 0.2; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Filter by Animal</h3>
  <label><input type="checkbox" value="Dog" checked> Dog</label><br>
  <label><input type="checkbox" value="Cat" checked> Cat</label>
</div>
<div id="graph"></div>

<script>

// Google Sheets CSV URLs (publish each sheet as CSV)
const citiesCSV = "https://docs.google.com/spreadsheets/d/e/1TKsoH-CVhXjJ7vMptfTukRO6wWO_1KGpS76yHu29Omc/pub?gid=0&single=true&output=csv";
const routesCSV = "https://docs.google.com/spreadsheets/d/e/1TKsoH-CVhXjJ7vMptfTukRO6wWO_1KGpS76yHu29Omc/pub?gid=1&single=true&output=csv";

Promise.all([
  d3.csv(citiesCSV),
  d3.csv(routesCSV)
]).then(([cities, routes]) => {

  // Ensure headers: CityName, HouseAnimals and FromCity, ToCity, Animals
  const nodes = {};
  cities.forEach(c => {
    // Split HouseAnimals by comma, trim whitespace
    nodes[c.CityName] = { id: c.CityName, animals: c.HouseAnimals.split(",").map(a => a.trim()) };
  });

  const links = routes.map(r => ({
    source: r.FromCity,
    target: r.ToCity,
    animals: r.Animals.split(",").map(a => a.trim())
  }));

  // Node degree
  Object.values(nodes).forEach(n => {
    n.degree = links.filter(l => l.source === n.id || l.target === n.id).length;
  });

  const width = window.innerWidth - 220;
  const height = window.innerHeight;

  const svg = d3.select("#graph").append("svg")
    .attr("width", width)
    .attr("height", height);

  // Arrowhead
  svg.append("defs").append("marker")
    .attr("id", "arrowhead")
    .attr("viewBox", "-0 -5 10 10")
    .attr("refX", 15)
    .attr("refY", 0)
    .attr("orient", "auto")
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("xoverflow", "visible")
    .append("svg:path")
      .attr("d", "M 0,-5 L 10 ,0 L 0,5")
      .attr("fill", "#999")
      .style("stroke", "none");

  // Force simulation
  const simulation = d3.forceSimulation(Object.values(nodes))
    .force("link", d3.forceLink(links).id(d => d.id).distance(150))
    .force("charge", d3.forceManyBody().strength(-400))
    .force("center", d3.forceCenter(width / 2, height / 2));

  // Draw links
  const link = svg.append("g")
    .attr("class", "links")
    .selectAll("path")
    .data(links)
    .enter().append("path")
    .attr("class", "link");

  // Draw nodes
  const node = svg.append("g")
    .attr("class", "nodes")
    .selectAll("g")
    .data(Object.values(nodes))
    .enter().append("g")
    .attr("class", "node");

  node.append("circle")
    .attr("r", d => 5 + d.degree * 2)
    .attr("fill", "#69b3a2");

  node.append("text")
    .text(d => d.id)
    .attr("x", 10)
    .attr("y", 4);

  simulation.on("tick", () => {
    link.attr("d", d => {
      const dx = d.target.x - d.source.x;
      const dy = d.target.y - d.source.y;
      const dr = Math.sqrt(dx * dx + dy * dy);
      return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
    });
    node.attr("transform", d => `translate(${d.x},${d.y})`);
  });

  // Filter
  d3.selectAll("#sidebar input[type=checkbox]").on("change", () => {
    const selectedAnimals = Array.from(document.querySelectorAll("#sidebar input[type=checkbox]:checked")).map(d => d.value);

    node.classed("hidden", d => !d.animals.some(a => selectedAnimals.includes(a)));
    link.classed("hidden", d => !d.animals.some(a => selectedAnimals.includes(a)));
  });

});

</script>
</body>
</html>
